name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: read

jobs:
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
            archive: tar.gz
            use_cross: false
          - target: aarch64-unknown-linux-gnu
            runner: ubuntu-latest
            archive: tar.gz
            use_cross: true
          - target: x86_64-apple-darwin
            runner: macos-latest
            archive: tar.gz
            use_cross: false
          - target: aarch64-apple-darwin
            runner: macos-latest
            archive: tar.gz
            use_cross: false
          - target: x86_64-pc-windows-msvc
            runner: windows-latest
            archive: zip
            use_cross: false

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Install cross
        if: matrix.use_cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build
        run: ${{ matrix.use_cross && 'cross' || 'cargo' }} build --release --target ${{ matrix.target }}
        shell: bash

      - name: Package (Unix)
        if: matrix.archive == 'tar.gz'
        run: |
          staging="sshore-${{ matrix.target }}"
          mkdir -p "$staging"
          cp target/${{ matrix.target }}/release/sshore "$staging/"
          cp LICENSE README.md "$staging/"
          tar czf "$staging.tar.gz" "$staging"
        shell: bash

      - name: Package (Windows)
        if: matrix.archive == 'zip'
        run: |
          staging="sshore-${{ matrix.target }}"
          mkdir -p "$staging"
          cp target/${{ matrix.target }}/release/sshore.exe "$staging/"
          cp LICENSE README.md "$staging/"
          7z a "$staging.zip" "$staging"
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sshore-${{ matrix.target }}
          path: sshore-${{ matrix.target }}.*

  release:
    name: Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd artifacts
          sha256sum sshore-*.tar.gz sshore-*.zip > checksums.sha256
          cat checksums.sha256

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            artifacts/sshore-*.tar.gz
            artifacts/sshore-*.zip
            artifacts/checksums.sha256

  publish-homebrew:
    name: Update Homebrew tap
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Validate version format
        run: |
          version="${GITHUB_REF_NAME#v}"
          if [[ ! "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Invalid version format: $version (expected semver)"
            exit 1
          fi

      - name: Download release archives
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download "$GITHUB_REF_NAME" \
            --repo "$GITHUB_REPOSITORY" \
            --pattern "sshore-*-apple-darwin.tar.gz" \
            --pattern "sshore-*-unknown-linux-gnu.tar.gz"

      - name: Compute SHA256 hashes
        id: sha
        run: |
          echo "macos_arm64=$(sha256sum sshore-aarch64-apple-darwin.tar.gz | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "macos_x86_64=$(sha256sum sshore-x86_64-apple-darwin.tar.gz | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "linux_arm64=$(sha256sum sshore-aarch64-unknown-linux-gnu.tar.gz | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "linux_x86_64=$(sha256sum sshore-x86_64-unknown-linux-gnu.tar.gz | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"

      - name: Generate formula from template
        env:
          VERSION: ${{ steps.version.outputs.version }}
          SHA_MACOS_ARM64: ${{ steps.sha.outputs.macos_arm64 }}
          SHA_MACOS_X86_64: ${{ steps.sha.outputs.macos_x86_64 }}
          SHA_LINUX_ARM64: ${{ steps.sha.outputs.linux_arm64 }}
          SHA_LINUX_X86_64: ${{ steps.sha.outputs.linux_x86_64 }}
        run: |
          cp packaging/homebrew/sshore.rb Formula.rb
          sed -i "s/__VERSION__/${VERSION}/g" Formula.rb
          sed -i "s/__SHA256_MACOS_ARM64__/${SHA_MACOS_ARM64}/g" Formula.rb
          sed -i "s/__SHA256_MACOS_X86_64__/${SHA_MACOS_X86_64}/g" Formula.rb
          sed -i "s/__SHA256_LINUX_ARM64__/${SHA_LINUX_ARM64}/g" Formula.rb
          sed -i "s/__SHA256_LINUX_X86_64__/${SHA_LINUX_X86_64}/g" Formula.rb
          echo "--- Generated formula ---"
          cat Formula.rb

      - name: Push to Homebrew tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          git config --global credential.helper store
          echo "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com" > ~/.git-credentials
          git clone https://github.com/aitechnerd/homebrew-sshore.git tap
          mkdir -p tap/Formula
          cp Formula.rb tap/Formula/sshore.rb
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/sshore.rb
          git commit -m "sshore ${VERSION}"
          git push
          rm -f ~/.git-credentials
